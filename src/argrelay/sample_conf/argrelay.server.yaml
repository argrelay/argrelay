# `argrelay` server config: https://github.com/argrelay/argrelay

connection_config:
    server_host_name: localhost
    server_port_number: 8787

mongo_config:
    use_mongomock: True
    distinct_values_query: original_find_and_loop
    mongo_client:
        # See `MongoClientConfigSchema` for detailed connection string format:
        client_connection_string: mongodb://localhost
    mongo_server:
        database_name: argrelay
        start_server: True
        # See `mongo_notes.md`:
        server_start_command: ~/argrelay.git/tmp/mongo/mongodb-linux-x86_64-rhel80-6.0.3/bin/mongod --dbpath ~/argrelay.git/tmp/mongo/data

query_cache_config:
    enable_query_cache: True
    query_cache_ttl_sec: 60
    query_cache_max_size_bytes: 10485760 # 10 MiB

gui_banner_config:

    header_html: |
        <div style="color: grey; font-size: small;">

        This is a demo GUI client for a server with mocked data.<br/>
        A GUI client cannot execute commands.<br/>
        To execute commands, use a <a href="https://github.com/argrelay/argrelay#argrelay-demo" target="_blank">CLI client</a> instead.<br/>
        <br/>
        To try auto-completion, type either|or:
        <ul>
            <li>relay_demo goto host</li>
            <li>relay_demo goto service</li>
        </ul>
        Then, narrow down search by... IP, region, etc.

        </div>

    footer_html: |
        <div style="color: grey; font-size: small;">

        <details>
        <summary>Try a <a href="https://github.com/argrelay/argrelay#argrelay-demo" target="_blank">CLI client</a> for full functionality.</summary>
        <br/>
        <h3>Details on GUI client deliberate limitations</h3>

        This test/demo GUI client allows simple browser-only access by anyone with URL (without shell access and shell config required for a CLI client).<br/>
        It is convenient for data search, testing, diagnostic, but it is not meant to be functional (use a CLI client for that).<br/>
        <br/>
        Normally, a CLI client receives equivalent responses (as this GUI client does) from the server <a href="https://github.com/argrelay/argrelay#argrelay-request-hotkeys" target="_blank">on request hotkeys<a>:
        <ol>
            <li>auto-completion options (on Tab)</li>
            <li>search responses (on Alt+Shift+Q)</li>
            <li>command invocation data (on Enter)</li>
        </ol>
        However, this GUI client is limited and slightly different from a CLI client:
        <ul>
            <li>(1) Tab is only used to complete `common_infix` - request to provide suggestions is sent automatically on idle timeout.</li>
            <li>(2) Search request (Alt+Shift+Q) is sent automatically on idle timeout.</li>
            <li>(3) Command invocation (Enter) is disabled - it only prints invocation data from the server (use a CLI client to run commands).</li>
        </ul>
        </details>

        </div>

class_to_collection_map:
    ClassCluster: ClassCluster
    ClassHost: ClassHost
    ClassService: ClassService
    AccessType: AccessType

server_plugin_control:
    first_interp_factory_id: FirstArgInterpFactory
    reusable_config_data:

        jump_tree: &jump_tree
            relay_demo:
                intercept:
                    -   relay_demo
                help:
                    -   relay_demo
                enum:
                    -   relay_demo
                subtree:
                    intercept:
                        -   relay_demo
                        -   subtree
                    help:
                        -   relay_demo
                        -   subtree
                    enum:
                        -   relay_demo
                        -   subtree
            some_command:
                intercept:
                    -   some_command
                help:
                    -   some_command
                enum:
                    -   some_command
                subtree:
                    intercept:
                        -   some_command
                        -   subtree
                    help:
                        -   some_command
                        -   subtree
                    enum:
                        -   some_command
                        -   subtree
            service_relay_demo:
                help:
                    -   service_relay_demo

        interp_sub_tree: &interp_sub_tree
            intercept: JumpTreeInterpFactory.intercept_invocation_func
            help: JumpTreeInterpFactory.help_hint_func
            enum: JumpTreeInterpFactory.query_enum_items_func
            "": FuncTreeInterpFactory

        all_direct_delegators: &all_direct_delegators
            -   NoopDelegator
            -   EchoDelegator
            -   ServiceDelegator
            -   GitRepoDelegator
            -   ConfigOnlyDelegator

plugin_instance_entries:

    FirstArgInterpFactory:
        plugin_module_name: argrelay.plugin_interp.FirstArgInterpFactory
        plugin_class_name: FirstArgInterpFactory
        plugin_dependencies:
            -   InterpTreeInterpFactory
            -   InterpTreeInterpFactory.service
        plugin_config:
            first_arg_vals_to_next_interp_factory_ids:
                # This binding uses existing file system name `relay_demo`:
                relay_demo: InterpTreeInterpFactory
                # Another equivalent binding
                # (if `some_command` is configured, it will behave as `relay_demo` above):
                some_command: InterpTreeInterpFactory
                service_relay_demo: InterpTreeInterpFactory.service

    InterpTreeInterpFactory:
        plugin_module_name: argrelay.plugin_interp.InterpTreeInterpFactory
        plugin_class_name: InterpTreeInterpFactory
        plugin_dependencies:
            -   JumpTreeInterpFactory.intercept_invocation_func
            -   JumpTreeInterpFactory.help_hint_func
            -   JumpTreeInterpFactory.query_enum_items_func
            -   FuncTreeInterpFactory
        plugin_config:
            interp_selector_tree:
                <<: *interp_sub_tree
                # child subtree matches parent:
                subtree: *interp_sub_tree

    InterpTreeInterpFactory.service:
        plugin_module_name: argrelay.plugin_interp.InterpTreeInterpFactory
        plugin_class_name: InterpTreeInterpFactory
        plugin_dependencies:
            -   JumpTreeInterpFactory.help_hint_func
            -   FuncTreeInterpFactory.service
        plugin_config:
            interp_selector_tree:
                help: JumpTreeInterpFactory.help_hint_func
                "": FuncTreeInterpFactory.service

    # TODO: FS_33_76_82_84 `global_tree`: maintaining separate instance of `JumpTreeInterpFactory` plugin should be avoided.
    #       See extended comment for `JumpTreeInterpFactory.help_hint_func`.
    JumpTreeInterpFactory.intercept_invocation_func:
        plugin_module_name: argrelay.plugin_interp.JumpTreeInterpFactory
        plugin_class_name: JumpTreeInterpFactory
        plugin_dependencies:
            -   InterceptDelegator
        plugin_config:
            jump_tree: *jump_tree
            func_selector_tree: intercept_invocation_func
            delegator_plugin_ids:
                -   InterceptDelegator

    # TODO: FS_33_76_82_84 `global_tree`: maintaining separate instance of `JumpTreeInterpFactory` plugin should be avoided.
    # `jump_tree` is already "global" which navigates back to another interpreter when function is selected.
    # `JumpTreeInterpFactory` extends `FuncTreeInterpFactory` to `select_next_interp_tree_abs_path`
    # (what base `FuncTreeInterpFactory` does not do because its `run_interp_control` returns None).
    # Func `select_next_interp_tree_abs_path` is where jump is performed based on current `interp_ctx.interp_tree_abs_path`.
    # What `run_interp_control` for `JumpTreeInterpFactory` does is to ask `HelpDelegator` what is the next
    # `plugin_id` (interp) to use, but it can be seen from the `global_tree` if specific tree path to `func_id`
    # leads to `global_tree_node` configuring that new path.
    # It means, regardless of the places to jump, there would be no need to configure new `JumpTreeInterpFactory`.
    JumpTreeInterpFactory.help_hint_func:
        plugin_module_name: argrelay.plugin_interp.JumpTreeInterpFactory
        plugin_class_name: JumpTreeInterpFactory
        plugin_dependencies:
            -   HelpDelegator
        plugin_config:
            jump_tree: *jump_tree
            func_selector_tree: help_hint_func
            delegator_plugin_ids:
                -   HelpDelegator

    # TODO: FS_33_76_82_84 `global_tree`: maintaining separate instance of `JumpTreeInterpFactory` plugin should be avoided.
    #       See extended comment for `JumpTreeInterpFactory.help_hint_func`.
    JumpTreeInterpFactory.query_enum_items_func:
        plugin_module_name: argrelay.plugin_interp.JumpTreeInterpFactory
        plugin_class_name: JumpTreeInterpFactory
        plugin_dependencies:
            -   QueryEnumDelegator
        plugin_config:
            jump_tree: *jump_tree
            func_selector_tree: query_enum_items_func
            delegator_plugin_ids:
                -   QueryEnumDelegator

    FuncTreeInterpFactory:
        plugin_module_name: argrelay.plugin_interp.FuncTreeInterpFactory
        plugin_class_name: FuncTreeInterpFactory
        plugin_dependencies: *all_direct_delegators
        plugin_config:
            func_selector_tree:
                echo: echo_args_func
                list:
                    host: list_host_func
                    service: list_service_func
                goto:
                    repo: goto_repo_func
                    host: goto_host_func
                    service: goto_service_func
                desc:
                    commit: desc_commit_func
                    host: desc_host_func
                    service: desc_service_func
                config:
                    print_with_level: funct_id_print_with_severity_level
                    print_with_exit: funct_id_print_with_exit_code
            delegator_plugin_ids: *all_direct_delegators

    FuncTreeInterpFactory.service:
        plugin_module_name: argrelay.plugin_interp.FuncTreeInterpFactory
        plugin_class_name: FuncTreeInterpFactory
        plugin_dependencies:
            -   ServiceDelegator
        plugin_config:
            func_selector_tree:
                goto: goto_service_func
                list: list_service_func
                desc: desc_service_func
            ignored_func_ids_list:
                -   goto_host_func
                -   list_host_func
                -   desc_host_func
            delegator_plugin_ids:
                -   ServiceDelegator

    NoopInterpFactory:
        plugin_module_name: argrelay.plugin_interp.NoopInterpFactory
        plugin_class_name: NoopInterpFactory

    NoopLoader:
        plugin_module_name: argrelay.plugin_loader.NoopLoader
        plugin_class_name: NoopLoader

    ServiceLoader:
        plugin_module_name: argrelay.custom_integ.ServiceLoader
        plugin_class_name: ServiceLoader
        plugin_config:
            test_data_ids_to_load:
                #-   TD_70_69_38_46  # no data
                -   TD_63_37_05_36  # demo
                # WARNING: with `mongomock` and not `enable_query_cache` requests run up for TD_38_03_48_51 may run up to 10 mins:
                #-   TD_38_03_48_51  # large generated

    GitRepoLoader:
        plugin_enabled: false
        plugin_module_name: argrelay.custom_integ.GitRepoLoader
        plugin_class_name: GitRepoLoader
        plugin_config:
            load_repo_commits: False
            repo_entries:
                "~/repos":
                    -
                        repo_rel_path: argrelay.git
                        envelope_properties:
                            GitRepoAlias: ar
                            GitRepoContentType: code
                    -
                        repo_rel_path: argcomplete.git
                        is_repo_enabled: True
                        envelope_properties:
                            GitRepoAlias: ac
                            GitRepoContentType: ref
                    -
                        repo_rel_path: marshmallow.git
                        is_repo_enabled: False
                        envelope_properties:
                            GitRepoAlias: mm
                            GitRepoContentType: code

    ConfigOnlyLoader:
        plugin_enabled: true
        plugin_module_name: argrelay.custom_integ.ConfigOnlyLoader
        plugin_class_name: ConfigOnlyLoader
        plugin_config:
            class_names:
                -   ConfigOnlyClass
            index_fields:
                -   severity_level
                -   exit_code
            data_envelopes:
                -
                    EnvelopeClass: ConfigOnlyClass
                    severity_level: INFO
                    exit_code: 0
                    envelope_payload:
                        text_message: text message A
                -
                    EnvelopeClass: ConfigOnlyClass
                    severity_level: WARN
                    exit_code: 0
                    envelope_payload:
                        text_message: text message B
                -
                    EnvelopeClass: ConfigOnlyClass
                    severity_level: ERROR
                    exit_code: 1
                    envelope_payload:
                        text_message: text message C
                -
                    EnvelopeClass: ConfigOnlyClass
                    severity_level: ERROR
                    exit_code: 2
                    envelope_payload:
                        text_message: text message D

    NoopDelegator:
        plugin_module_name: argrelay.plugin_delegator.NoopDelegator
        plugin_class_name: NoopDelegator

    EchoDelegator:
        plugin_module_name: argrelay.plugin_delegator.EchoDelegator
        plugin_class_name: EchoDelegator

    InterceptDelegator:
        plugin_module_name: argrelay.plugin_delegator.InterceptDelegator
        plugin_class_name: InterceptDelegator
        plugin_dependencies:
            -   FuncTreeInterpFactory
        plugin_config:
            tree_abs_path_to_interp_id:
                relay_demo:
                    intercept: InterpTreeInterpFactory
                    subtree:
                        intercept: InterpTreeInterpFactory
                some_command:
                    intercept: InterpTreeInterpFactory
                    subtree:
                        intercept: InterpTreeInterpFactory

    HelpDelegator:
        plugin_module_name: argrelay.plugin_delegator.HelpDelegator
        plugin_class_name: HelpDelegator
        plugin_dependencies:
            -   FuncTreeInterpFactory
        plugin_config:
            tree_abs_path_to_interp_id:
                relay_demo:
                    help: InterpTreeInterpFactory
                    subtree:
                        help: InterpTreeInterpFactory
                some_command:
                    help: InterpTreeInterpFactory
                    subtree:
                        help: InterpTreeInterpFactory
                service_relay_demo:
                    help: InterpTreeInterpFactory.service

    QueryEnumDelegator:
        plugin_module_name: argrelay.plugin_delegator.QueryEnumDelegator
        plugin_class_name: QueryEnumDelegator
        plugin_dependencies:
            -   FuncTreeInterpFactory
        plugin_config:
            tree_abs_path_to_interp_id:
                relay_demo:
                    enum: InterpTreeInterpFactory
                    subtree:
                        enum: InterpTreeInterpFactory
                some_command:
                    enum: InterpTreeInterpFactory
                    subtree:
                        enum: InterpTreeInterpFactory

    ServiceDelegator:
        plugin_module_name: argrelay.custom_integ.ServiceDelegator
        plugin_class_name: ServiceDelegator

    GitRepoDelegator:
        plugin_module_name: argrelay.custom_integ.GitRepoDelegator
        plugin_class_name: GitRepoDelegator

    ConfigOnlyDelegator:
        plugin_module_name: argrelay.custom_integ.ConfigOnlyDelegator
        plugin_class_name: ConfigOnlyDelegator
        plugin_config:
            func_configs:
                funct_id_print_with_severity_level:
                    command_template: "echo \"{object_envelope['severity_level']}: {object_envelope['envelope_payload']['text_message']}\""
                    func_envelope:
                        HelpHint: "Instantiate command template by data from `data_envelope` and executed it: print `text_message` prefixed with `severity_level`"
                        instance_data:
                            search_control_list:
                                -   collection_name: ConfigOnlyClass
                                    envelope_class: ConfigOnlyClass
                                    keys_to_types_list:
                                        -   level: severity_level
                                        -   code: exit_code
                funct_id_print_with_exit_code:
                    command_template: "echo \"{object_envelope['envelope_payload']['text_message']}\" && exit {object_envelope['exit_code']}"
                    func_envelope:
                        HelpHint: "Instantiate command template by data from `data_envelope` and executed it: print `text_message` and exit with `exit_code`"
                        instance_data:
                            search_control_list:
                                -
                                    collection_name: ConfigOnlyClass
                                    envelope_class: ConfigOnlyClass
                                    keys_to_types_list:
                                        -   level: severity_level
                                        -   code: exit_code

    # TODO: Add FS_80_45_89_81 / `error_message` func:
    ErrorDelegator:
        plugin_module_name: argrelay.plugin_delegator.ErrorDelegator
        plugin_class_name: ErrorDelegator

    DefaultConfigurator:
        plugin_module_name: argrelay.plugin_config.DefaultConfigurator
        plugin_class_name: DefaultConfigurator
        plugin_config:
            project_title: relay_demo
            project_page_url: "https://argrelay.org"
            git_files_by_commit_id_url_prefix: "https://github.com/argrelay/argrelay/tree/"
            commit_id_url_prefix: "https://github.com/argrelay/argrelay/commit/"
